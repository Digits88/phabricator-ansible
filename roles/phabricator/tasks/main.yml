---
- name: Install packages
  apt:
    name:
    - mercurial
    - subversion
    - git
    - sendmail
    state: present

- name: Create phd user with admin privileges
  user:
    name: phd
    shell: /bin/bash
    group: admin
    append: yes

- name: Create git user
  user:
    name: git

- name: clone phabricator
  git: repo=https://github.com/phacility/phabricator.git dest=/home/phd/phabricator
  become: yes
  become_user: phd
  register: phabricator

- name: clone phutil
  become: yes
  become_user: phd
  git: repo=https://github.com/phacility/libphutil.git dest=/home/phd/libphutil

- name: clone arcanist
  become: yes
  become_user: phd
  git: repo=https://github.com/phacility/arcanist dest=/home/phd/arcanist

- name: Set Base URI
  command: ./bin/config set phabricator.base-uri 'http://phabricator.dev/'
  args:
    chdir: /home/phd/phabricator

# Setup MySQL configuration and initialize database storage
- include: database.yml

# Setup Nginx virtualhosts
- include: nginx.yml

# Setup Phd daemon
- include: daemon.yml

# Setup local disk file storage
- include: storage.yml

# Setup Imagemagick
- include: imagemagick.yml

# Setup Pygments
- include: pygments.yml

# Setup Diffusion
- include: diffusion.yml

